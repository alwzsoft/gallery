<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moa Admin - 기록하기</title>
    <style>
        body { font-family: 'Pretendard', -apple-system, system-ui, sans-serif; padding: 20px; background: #f9f8f5; color: #333; }
        .admin-card { max-width: 500px; margin: 40px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        textarea { height: 100px; resize: vertical; }
        button { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #preview-container { margin-top: 20px; text-align: center; display: none; }
        #preview { max-width: 100%; border-radius: 8px; border: 1px solid #eee; }
        .status-msg { margin-top: 15px; text-align: center; font-size: 0.9rem; min-height: 1.2rem; }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
    </style>
</head>
<body>

<div class="admin-card">
    <h2>Moa's Moment 기록</h2>
    
    <div class="form-group">
        <label for="token">GitHub Token</label>
        <input type="password" id="token" placeholder="ghp_..." autocomplete="current-password">
    </div>

    <div class="form-group">
        <label for="image-upload">사진 선택</label>
        <input type="file" id="image-upload" accept="image/*">
    </div>

    <div id="preview-container">
        <img id="preview">
    </div>

    <div class="form-group">
        <label for="title">제목</label>
        <input type="text" id="title" placeholder="사진 제목">
    </div>

    <div class="form-group">
        <label for="tags">태그</label>
        <input type="text" id="tags" placeholder="태그 (쉼표로 구분)">
    </div>

    <div class="form-group">
        <label for="description">설명</label>
        <textarea id="description" placeholder="Moa's Moment - Someday..."></textarea>
    </div>

    <button id="upload-btn" onclick="handleUpload()">Moa에 등록하기</button>
    <div id="status" class="status-msg"></div>
</div>

<script>
    const repo = "alwzsoft/source_only"; // 사용자님의 저장소명
    let selectedFile = null;

    // 이미지 선택 시 미리보기
    document.getElementById('image-upload').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = function(event) {
            const preview = document.getElementById('preview');
            const container = document.getElementById('preview-container');
            preview.src = event.target.result;
            container.style.display = 'block';
        };
        reader.readAsDataURL(file);
    };

    function setStatus(msg, type = 'loading') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = msg;
        statusDiv.className = `status-msg ${type}`;
    }

    async function handleUpload() {
        const token = document.getElementById('token').value.trim();
        const title = document.getElementById('title').value.trim();
        const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
        const desc = document.getElementById('description').value.trim();
        const uploadBtn = document.getElementById('upload-btn');

        if (!selectedFile || !token || !title) return alert("필수 항목을 모두 채워주세요.");

        try {
            uploadBtn.disabled = true;
            setStatus("이미지 업로드 중...");

            const now = new Date();
            const timestamp = now.getTime();
            const extension = selectedFile.name.split('.').pop();
            const fileName = `public/picture/${timestamp}.${extension}`;

            const reader = new FileReader();
            reader.readAsArrayBuffer(selectedFile);
            reader.onloadend = async () => {
                const base64Data = btoa(new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                
                const imgRes = await uploadToGithub(token, fileName, base64Data, `Upload: ${title}`);
                if (!imgRes.ok) throw new Error("이미지 업로드에 실패했습니다.");

                setStatus("데이터 정보 업데이트 중...");
                await updateJsonData(token, {
                    img: fileName.replace('public/', ''),
                    title: title,
                    tags: tags,
                    description: desc,
                    date: now.toISOString().split('T')[0]
                });

                setStatus("기록 성공!", "success");
                alert("성공적으로 등록되었습니다!");
                location.reload();
            };
        } catch (err) {
            setStatus(`오류: ${err.message}`, "error");
            uploadBtn.disabled = false;
        }
    }

    async function uploadToGithub(token, path, content, message, sha = null) {
        const url = `https://api.github.com/repos/${repo}/contents/${path}`;
        const body = { message, content };
        if (sha) body.sha = sha;

        return fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
    }

    async function updateJsonData(token, newData) {
        // 1. 경로 설정 (저장소 루트 기준의 정확한 경로)
        const path = 'public/data/pictures.json';
        const url = `https://api.github.com/repos/${repo}/contents/${path}`;
        
        let currentList = [];
        let sha = null;

        try {
            // 2. 기존 파일 가져오기 시도 (캐시 방지 타임스탬프 추가)
            const res = await fetch(`${url}?t=${Date.now()}`, { 
                headers: { 'Authorization': `token ${token}` } 
            });
            
            if (res.ok) {
                // 파일이 이미 존재하는 경우
                const fileData = await res.json();
                sha = fileData.sha;
                // UTF-8 디코딩 (한글 깨짐 방지)
                const currentContent = decodeURIComponent(atob(fileData.content).split('').map(c => 
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                currentList = JSON.parse(currentContent);
                console.log("기존 데이터를 성공적으로 불러왔습니다.");
            } else if (res.status === 404) {
                // 파일이 없는 경우 (새로 생성)
                console.warn("기존 JSON 파일이 없어 새 파일을 생성합니다.");
                currentList = [];
            } else {
                throw new Error(`GitHub API 응답 오류: ${res.status}`);
            }

            // 3. 새 데이터 추가 (최신순 정렬을 위해 맨 앞에 추가)
            currentList.unshift(newData);

            // 4. JSON 인코딩 (UTF-8)
            const updatedJson = JSON.stringify(currentList, null, 2);
            const updatedContent = btoa(encodeURIComponent(updatedJson).replace(/%([0-9A-F]{2})/g,
                (match, p1) => String.fromCharCode('0x' + p1)
            ));

            // 5. 깃허브에 전송 (sha가 있으면 수정, 없으면 생성)
            const updateRes = await uploadToGithub(token, path, updatedContent, "Update pictures.json via Admin", sha);
            
            if (!updateRes.ok) {
                const error = await updateRes.json();
                throw new Error(`저장 실패: ${error.message}`);
            }

        } catch (err) {
            console.error("데이터 업데이트 실패:", err);
            throw err;
        }
    }
</script>
</body>
</html>