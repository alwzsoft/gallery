<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moa Admin - AI Smart Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        :root { --primary: #6b705c; --bg: #f8f9fa; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 30px; letter-spacing: -1px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; color: #555; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        .ai-box { background: #fdfdfd; border: 2px dashed #e9ecef; margin-bottom: 25px; }
        .btn-ai { background: #4a4e69; color: white; margin-top: 5px; }
        .btn-ai:hover { background: #22223b; }
        
        .btn-submit { background: var(--primary); color: white; margin-top: 10px; font-size: 1.1em; height: 55px; }
        .btn-submit:hover { background: #585d4d; }
        
        #preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #eee; }
        .proposal-card { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; cursor: pointer; font-size: 0.9em; border: 1px solid #dee2e6; transition: all 0.2s ease; }
        .proposal-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .proposal-card strong { color: var(--primary); display: block; margin-bottom: 4px; }
        
        #status { font-size: 0.85em; text-align: center; margin-top: 20px; color: #666; min-height: 1.5em; padding: 10px; border-radius: 4px; }
        .loading { color: var(--primary); font-weight: bold; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Moa Art Registry</h2>

    <div class="section">
        <label>1. ì‚¬ì§„ ì„ íƒ</label>
        <input type="file" id="photoInput" accept="image/*">
        <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
    </div>

    <div id="aiSection" class="section ai-box" style="display:none;">
        <label>2. AI ê°ì„± íë ˆì´ì…˜ (ì„ íƒ)</label>
        <input type="password" id="geminiKey" placeholder="Gemini API Keyë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”">
        <button class="btn-ai" onclick="askGemini()">âœ¨ AIì—ê²Œ ë¬¸êµ¬ 3ê°œ ì œì•ˆë°›ê¸°</button>
        <div id="proposals"></div>
    </div>

    <div class="section">
        <label>3. ìƒì„¸ ì •ë³´ í™•ì¸</label>
        <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ê±°ë‚˜ AI ì œì•ˆì„ ì„ íƒí•˜ì„¸ìš”">
        <input type="text" id="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„ ì˜ˆ: í’ê²½, ì—¬í–‰, ì˜¤í›„)">
        <textarea id="description" rows="3" placeholder="ì‚¬ì§„ì— ë‹´ê¸´ ì§§ì€ ë¬¸ì¥ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”"></textarea>
        
        <label style="margin-top:10px; color: #888;">GitHub ê¶Œí•œ ì„¤ì •</label>
        <input type="password" id="ghToken" placeholder="GitHub Personal Access Token (ghp_...)">
        <button class="btn-submit" onclick="handleUpload()">ì˜¤ëŠ˜ì˜ ì‹œì„  ë“±ë¡í•˜ê¸°</button>
    </div>

    <div id="status"></div>
</div>

<script>
    // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = () => {
        document.getElementById('ghToken').value = localStorage.getItem('moa_gh_token') || '';
        document.getElementById('geminiKey').value = localStorage.getItem('moa_gemini_key') || '';
    };

    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    let selectedFile = null;
    let exifData = { lat: null, lon: null };

    // ì‚¬ì§„ ì„ íƒ ì´ë²¤íŠ¸
    photoInput.onchange = (e) => {
        selectedFile = e.target.files[0];
        if (!selectedFile) return;

        const reader = new FileReader();
        reader.onload = (ex) => {
            preview.src = ex.target.result;
            preview.style.display = 'block';
            document.getElementById('aiSection').style.display = 'block';
            document.getElementById('proposals').innerHTML = '';
        };
        reader.readAsDataURL(selectedFile);

        // ìœ„ì¹˜ ì •ë³´ ì¶”ì¶œ
        EXIF.getData(selectedFile, function() {
            const lat = EXIF.getTag(this, "GPSLatitude");
            const lon = EXIF.getTag(this, "GPSLongitude");
            if (lat && lon) {
                exifData.lat = lat[0] + lat[1]/60 + lat[2]/3600;
                exifData.lon = lon[0] + lon[1]/60 + lon[2]/3600;
            }
        });
    };

    // Gemini API í˜¸ì¶œ
    async function askGemini() {
        const apiKey = document.getElementById('geminiKey').value.trim();
        if (!apiKey) return alert("Gemini API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        localStorage.setItem('moa_gemini_key', apiKey);

        const status = document.getElementById('status');
        status.innerHTML = "<span class='loading'>ì‚¬ì§„ì˜ ë¶„ìœ„ê¸°ë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤...</span>";

        try {
            const base64Img = await toBase64(selectedFile);
            const prompt = `ì‚¬ì§„ì˜ ìœ„ì¹˜ì •ë³´(ìœ„ë„:${exifData.lat}, ê²½ë„:${exifData.lon})ë¥¼ ì°¸ê³ í•´ì„œ, 
            ê°¤ëŸ¬ë¦¬ 'Moa'ì˜ ì»¨ì…‰(ë”°ëœ»í•¨, ì •ê°ˆí•¨, ê¸°ë¡, ì‹œì„ )ì— ì–´ìš¸ë¦¬ëŠ” í¬ìŠ¤íŒ… í›„ë³´ 3ê°œë¥¼ JSONìœ¼ë¡œ ì œì•ˆí•´ì¤˜.
            ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´:
            {"proposals": [{"title": "ì œëª©", "tags": "íƒœê·¸1, íƒœê·¸2", "desc": "ê°ì„± ë¬¸êµ¬"}]}`;

            // ğŸŒŸ ìˆ˜ì •ëœ ë¶€ë¶„: v1 ê²½ë¡œ ì‚¬ìš© + ëª¨ë¸ëª… ì •ê·œí™”
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64Img.split(',')[1] } }
                    ]}]
                })
            });

            // ì‘ë‹µ ìƒíƒœ ì²´í¬ ì¶”ê°€
            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API ì‘ë‹µ ì—ëŸ¬ (${response.status}): ${errorBody.error.message}`);
            }

            const resData = await response.json();
            const textResponse = resData.candidates[0].content.parts[0].text;
            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            const cleanJson = JSON.parse(jsonMatch[0]);
            
            displayProposals(cleanJson.proposals);
            status.textContent = "ê°€ì¥ ë§ˆìŒì— ë“œëŠ” ì‹œì„ ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        } catch (err) {
            console.error(err);
            status.textContent = "AI ì˜¤ë¥˜: " + err.message;
        }
}

    function displayProposals(proposals) {
        const container = document.getElementById('proposals');
        container.innerHTML = '';
        proposals.slice(0, 3).forEach(p => {
            const div = document.createElement('div');
            div.className = 'proposal-card';
            div.innerHTML = `<strong>${p.title}</strong><span>${p.desc}</span>`;
            div.onclick = () => {
                document.getElementById('title').value = p.title;
                document.getElementById('tags').value = p.tags;
                document.getElementById('description').value = p.desc;
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            };
            container.appendChild(div);
        });
    }

    async function handleUpload() {
        const token = document.getElementById('ghToken').value.trim();
        if (!token || !selectedFile) return alert("GitHub í† í°ê³¼ ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        localStorage.setItem('moa_gh_token', token);

        const status = document.getElementById('status');
        status.innerHTML = "<span class='loading'>GitHub ì €ì¥ì†Œì— ê¸°ë¡ì„ ë‚¨ê¸°ëŠ” ì¤‘...</span>";

        const repo = "alwzsoft/source_only";
        const fileName = Date.now() + ".jpg";
        const imgPath = `gallery/public/picture/${fileName}`;
        const jsonPath = `gallery/public/data/pictures.json`;

        try {
            const imgBase64 = (await toBase64(selectedFile)).split(',')[1];
            
            // 1. ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ
            await fetch(`https://api.github.com/repos/${repo}/contents/${imgPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "New photo upload", content: imgBase64 })
            });

            // 2. JSON ë°ì´í„° ì—…ë°ì´íŠ¸ (ìºì‹œ ë°©ì§€ v íŒŒë¼ë¯¸í„° ì¶”ê°€)
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}?v=${Date.now()}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const fileData = await res.json();
            const currentContent = decodeURIComponent(atob(fileData.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            let currentList = JSON.parse(currentContent);

            currentList.unshift({
                img: `picture/${fileName}`,
                title: document.getElementById('title').value,
                date: new Date().toISOString().split('T')[0],
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
                description: document.getElementById('description').value
            });

            // í•œê¸€ ì²˜ë¦¬ë¥¼ ìœ„í•œ btoa ë³´ê°•
            const updatedContent = btoa(encodeURIComponent(JSON.stringify(currentList, null, 2)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));

            await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Update pictures.json", content: updatedContent, sha: fileData.sha })
            });

            status.innerHTML = "<b>âœ… ë“±ë¡ ì„±ê³µ!</b> ê°¤ëŸ¬ë¦¬ê°€ ê³§ ë°°í¬ë©ë‹ˆë‹¤.";
            setTimeout(() => location.reload(), 2500);
        } catch (err) {
            status.textContent = "ì—…ë¡œë“œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
</script>
</body>
</html>