<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moa Admin - ê¸°ë¡í•˜ê¸°</title>
    <style>
        body { font-family: 'Pretendard', -apple-system, system-ui, sans-serif; padding: 20px; background: #f9f8f5; color: #333; }
        .admin-card { max-width: 500px; margin: 40px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        textarea { height: 100px; resize: vertical; }
        button { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #preview-container { margin-top: 20px; text-align: center; display: none; }
        #preview { max-width: 100%; border-radius: 8px; border: 1px solid #eee; }
        .status-msg { margin-top: 15px; text-align: center; font-size: 0.9rem; min-height: 1.2rem; }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
    </style>
</head>
<body>

<div class="admin-card">
    <h2>Moa's Moment ê¸°ë¡</h2>
    
    <div class="form-group">
        <label for="token">GitHub Token</label>
        <input type="password" id="token" placeholder="ghp_..." autocomplete="current-password">
    </div>

    <div class="form-group">
        <label for="image-upload">ì‚¬ì§„ ì„ íƒ</label>
        <input type="file" id="image-upload" accept="image/*">
    </div>

    <div id="preview-container">
        <img id="preview">
    </div>

    <div class="form-group">
        <label for="title">ì œëª©</label>
        <input type="text" id="title" placeholder="ì‚¬ì§„ ì œëª©">
    </div>

    <div class="form-group">
        <label for="tags">íƒœê·¸</label>
        <input type="text" id="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
    </div>

    <div class="form-group">
        <label for="description">ì„¤ëª…</label>
        <textarea id="description" placeholder="ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    </div>

    <button id="upload-btn" onclick="handleUpload()">Moaì— ë“±ë¡í•˜ê¸°</button>
    <div id="status" class="status-msg"></div>
</div>

<script>
    // 1. ì €ì¥ì†Œ ì •ë³´ ì„¤ì •
    const repo = "alwzsoft/source_only"; 
    let selectedFile = null;

    // ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ë¡œì§
    document.getElementById('image-upload').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = function(event) {
            const preview = document.getElementById('preview');
            const container = document.getElementById('preview-container');
            preview.src = event.target.result;
            container.style.display = 'block';
        };
        reader.readAsDataURL(file);
    };

    function setStatus(msg, type = 'loading') {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = msg;
        statusDiv.className = `status-msg ${type}`;
    }

    // ì—…ë¡œë“œ ë©”ì¸ í•¸ë“¤ëŸ¬
    async function handleUpload() {
        const token = document.getElementById('token').value.trim();
        const title = document.getElementById('title').value.trim();
        const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
        const desc = document.getElementById('description').value.trim();
        const uploadBtn = document.getElementById('upload-btn');

        if (!selectedFile || !token || !title) return alert("í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.");

        try {
            uploadBtn.disabled = true;
            setStatus("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...");

            const now = new Date();
            const timestamp = now.getTime();
            const extension = selectedFile.name.split('.').pop();
            
            // ğŸ’¡ ê²½ë¡œ ìˆ˜ì •: gallery/ í´ë” ë‚´ë¶€ë¡œ ì§€ì •
            const fileName = `gallery/public/picture/${timestamp}.${extension}`;

            const reader = new FileReader();
            reader.readAsArrayBuffer(selectedFile);
            reader.onloadend = async () => {
                const base64Data = btoa(new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
                
                // 1. ì´ë¯¸ì§€ ì—…ë¡œë“œ
                const imgRes = await uploadToGithub(token, fileName, base64Data, `Upload: ${title}`);
                if (!imgRes.ok) throw new Error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");

                setStatus("ë°ì´í„° ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘...");
                
                // 2. JSON ë°ì´í„° ì—…ë°ì´íŠ¸ (gallery/ ê²½ë¡œ ì „ë‹¬)
                await updateJsonData(token, {
                    img: `picture/${timestamp}.${extension}`, // ì‚¬ì´íŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¬ ë•Œì˜ ìƒëŒ€ ê²½ë¡œ
                    title: title,
                    tags: tags,
                    description: desc,
                    date: now.toISOString().split('T')[0]
                });

                setStatus("ê¸°ë¡ ì„±ê³µ!", "success");
                alert("ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ì ì‹œ í›„ í™ˆí˜ì´ì§€ì— ë°˜ì˜ë©ë‹ˆë‹¤.");
                location.reload();
            };
        } catch (err) {
            setStatus(`ì˜¤ë¥˜: ${err.message}`, "error");
            console.error(err);
            uploadBtn.disabled = false;
        }
    }

    // GitHub API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜
    async function uploadToGithub(token, path, content, message, sha = null) {
        const url = `https://api.github.com/repos/${repo}/contents/${path}`;
        const body = { 
            message, 
            content,
            branch: "main" // main ë¸Œëœì¹˜ ê³ ì •
        };
        if (sha) body.sha = sha;

        return fetch(url, {
            method: 'PUT',
            headers: { 
                'Authorization': `token ${token}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(body)
        });
    }

    // JSON ë°ì´í„° ì½ì–´ì„œ ìˆ˜ì • í›„ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    async function updateJsonData(token, newData) {
        // ğŸ’¡ ê²½ë¡œ ìˆ˜ì •: gallery/ í´ë” ë‚´ë¶€ì˜ JSON ì§€ì •
        const path = 'gallery/public/data/pictures.json';
        const url = `https://api.github.com/repos/${repo}/contents/${path}?t=${Date.now()}`;
        
        let currentList = [];
        let sha = null;

        const res = await fetch(url, { 
            headers: { 'Authorization': `token ${token}` } 
        });
        
        if (res.ok) {
            const fileData = await res.json();
            sha = fileData.sha;
            // í•œê¸€ ê¹¨ì§ ë°©ì§€ ë””ì½”ë”©
            const currentContent = decodeURIComponent(atob(fileData.content).split('').map(c => 
                '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            currentList = JSON.parse(currentContent);
        }

        currentList.unshift(newData); // ìµœì‹  ë°ì´í„°ë¥¼ ë§¨ ì•ìœ¼ë¡œ
        
        // ì¸ì½”ë”© í›„ ì €ì¥
        const updatedJson = JSON.stringify(currentList, null, 2);
        const updatedContent = btoa(encodeURIComponent(updatedJson).replace(/%([0-9A-F]{2})/g, 
            (match, p1) => String.fromCharCode('0x' + p1)));

        const updateRes = await uploadToGithub(token, path, updatedContent, "Update pictures.json via Admin", sha);
        if (!updateRes.ok) throw new Error("JSON ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
    }
</script>
</body>
</html>