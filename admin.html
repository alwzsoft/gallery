<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moa Art Registry - AI Curator</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        :root { --primary: #6b705c; --bg: #f8f9fa; --accent: #b7b7a4; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; padding: 20px; line-height: 1.7; }
        .container { max-width: 650px; margin: 0 auto; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: var(--primary); font-weight: 300; letter-spacing: 2px; margin-bottom: 40px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #f0f0f0; border-radius: 10px; }
        label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 0.9em; color: var(--primary); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 15px; font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); }
        button { width: 100%; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        .btn-ai { background: #4a4e69; color: white; margin-bottom: 10px; }
        .btn-ai:hover { background: #22223b; }
        .btn-submit { background: var(--primary); color: white; font-size: 1.1em; }
        .btn-submit:hover { background: #585d4d; }
        
        #preview { width: 100%; border-radius: 8px; margin-top: 15px; display: none; filter: grayscale(20%); }
        .proposal-card { background: #fff; padding: 20px; margin-top: 15px; border-radius: 8px; cursor: pointer; border: 1px solid #eee; transition: 0.2s; }
        .proposal-card:hover { border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .proposal-card strong { display: block; font-size: 1.1em; color: var(--primary); margin-bottom: 8px; }
        .proposal-card p { font-size: 0.95em; color: #666; margin: 0; word-break: keep-all; }
        
        #status { font-size: 0.85em; text-align: center; margin-top: 25px; color: #888; min-height: 1.5em; }
    </style>
</head>
<body>

<div class="container">
    <h2>MOA Art Registry</h2>

    <div class="section">
        <label>ğŸ“¸ ì˜¤ëŠ˜ì˜ ì‹œì„  ê¸°ë¡</label>
        <input type="file" id="photoInput" accept="image/*">
        <img id="preview">
    </div>

    <div id="aiSection" class="section" style="display:none;">
        <label>âœ¨ AI ê°ì„± íë ˆì´ì…˜</label>
        <input type="password" id="geminiKey" placeholder="Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button class="btn-ai" onclick="askGemini()">ì´ë¯¸ì§€ ë¶„ì„ ë° ë¬¸êµ¬ ì œì•ˆ</button>
        <div id="proposals"></div>
    </div>

    <div class="section">
        <label>ğŸ–‹ï¸ ìƒì„¸ ê¸°ë¡</label>
        <input type="text" id="title" placeholder="ì œëª© (ì‹ ë¦¬ ì„±ì§€ sinri-seonji)">
        <input type="text" id="tags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)">
        <textarea id="description" rows="5" placeholder="ì‚¬ì§„ì— ë‹´ê¸´ ì¹¨ë¬µì˜ ìˆœê°„ì„ ê¸°ë¡í•©ë‹ˆë‹¤."></textarea>
        
        <input type="password" id="ghToken" placeholder="GitHub Access Token">
        <button class="btn-submit" onclick="handleUpload()">ê°¤ëŸ¬ë¦¬ì— ë“±ë¡í•˜ê¸°</button>
    </div>

    <div id="status"></div>
</div>

<script>
    // ê¸°ì¡´ í‚¤ ë¡œë“œ
    window.onload = () => {
        document.getElementById('ghToken').value = localStorage.getItem('moa_gh_token') || '';
        document.getElementById('geminiKey').value = localStorage.getItem('moa_gemini_key') || '';
    };

    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    let selectedFile = null;

    photoInput.onchange = (e) => {
        selectedFile = e.target.files[0];
        if (!selectedFile) return;
        const reader = new FileReader();
        reader.onload = (ex) => {
            preview.src = ex.target.result;
            preview.style.display = 'block';
            document.getElementById('aiSection').style.display = 'block';
        };
        reader.readAsDataURL(selectedFile);
    };

    async function askGemini() {
        const apiKey = document.getElementById('geminiKey').value.trim();
        if (!apiKey) return alert("API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        localStorage.setItem('moa_gemini_key', apiKey);

        const status = document.getElementById('status');
        status.innerHTML = "<b>ë§¤ê±°ì§„ì˜ ì‹œì„ ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ í•´ì„í•˜ëŠ” ì¤‘...</b>";

        try {
            const base64Img = await toBase64(selectedFile);
            
            // ğŸŒŸ ì‚¬ìš©ì ë§ì¶¤í˜• í”„ë¡¬í”„íŠ¸: í•œêµ­ì  ë¯¸ + ì€ìœ ì  ë¬¸ì¥ + ì˜ì–´ ë³‘ê¸°
            const prompt = `ì´ ì‚¬ì§„ì„ ë³´ê³  ì´ë¯¸ì§€ ë§¤ê±°ì§„ 'Moa'ì˜ ê°ì„±ìœ¼ë¡œ íë ˆì´ì…˜í•´ì¤˜. 
            ì»¨ì…‰: í•œêµ­ì ì¸ ë¯¸, ì •ê²°í•¨, ê³ ìš”í•œ ì§ˆì„œ, ì¹¨ë¬µì˜ ìˆœê°„, ë”°ëœ»í•¨.
            ìš”ì²­ ì‚¬í•­:
            1. ë¬¸ì¥: ì„¤ëª…ë³´ë‹¤ëŠ” ì€ìœ ì ì´ê³  ë¹„ìœ ì ì¸ ì‹œì ì¸ ë¬¸ì²´ë¡œ ì‘ì„±í•  ê²ƒ (ë¶„ëŸ‰ì€ 150ì ë‚´ì™¸). ì˜ì–´ë¡œë„ ë™ì¼í•œ ê°ì„±ì„ ìœ ì§€í•œ ë²ˆì—­ì„ í¬í•¨í•  ê²ƒ.
            2. ì œëª©: í•œêµ­ì–´ ì œëª© ì˜†ì— ë°œìŒ ê·¸ëŒ€ë¡œì˜ ì˜ì–´ í‘œê¸°ë¥¼ ë³‘ê¸°í•  ê²ƒ (ì˜ˆ: ì‹ ë¦¬ ì„±ì§€ sinri-seonji).
            3. íƒœê·¸: í•œêµ­ì–´ì™€ ì˜ì–´ íƒœê·¸ë¥¼ ì„ì–´ì„œ 5ê°œ ì´ìƒ ì œì•ˆí•  ê²ƒ.
            
            ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•  ê²ƒ:
            {"proposals": [{"title": "ì œëª© (ì˜ì–´ë°œìŒ)", "tags": "íƒœê·¸, tag", "desc": "í•œê¸€ ì‹œì  ë¬¸ì¥\\n\\nEnglish poetic description"}]}`;

            // ê²€ì¦ëœ gemini-2.0-flash ëª¨ë¸ ì‚¬ìš©
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64Img.split(',')[1] } }
                    ]}]
                })
            });

            const resData = await response.json();
            if (resData.error) {
                if(resData.error.code === 429) throw new Error("í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. 1ë¶„ë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.");
                throw new Error(resData.error.message);
            }

            const textResponse = resData.candidates[0].content.parts[0].text;
            const jsonMatch = textResponse.match(/\{[\s\S]*\}/);
            const cleanJson = JSON.parse(jsonMatch[0]);
            
            displayProposals(cleanJson.proposals);
            status.textContent = "ê°€ì¥ ê¹Šì´ ë‹¿ëŠ” ë¬¸ì¥ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        } catch (err) {
            status.textContent = "ì˜¤ë¥˜: " + err.message;
        }
    }

    function displayProposals(proposals) {
        const container = document.getElementById('proposals');
        container.innerHTML = '';
        proposals.slice(0, 3).forEach(p => {
            const div = document.createElement('div');
            div.className = 'proposal-card';
            div.innerHTML = `<strong>${p.title}</strong><p>${p.desc.replace(/\n/g, '<br>')}</p>`;
            div.onclick = () => {
                document.getElementById('title').value = p.title;
                document.getElementById('tags').value = p.tags;
                document.getElementById('description').value = p.desc;
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            };
            container.appendChild(div);
        });
    }

    async function handleUpload() {
        const token = document.getElementById('ghToken').value.trim();
        if (!token || !selectedFile) return alert("í•„ìˆ˜ í•­ëª©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
        localStorage.setItem('moa_gh_token', token);

        const status = document.getElementById('status');
        status.textContent = "ê¸°ë¡ì„ ì €ì¥ì†Œì— ìƒˆê¸°ëŠ” ì¤‘...";

        const repo = "alwzsoft/source_only";
        const fileName = Date.now() + ".jpg";
        const imgPath = `gallery/public/picture/${fileName}`;
        const jsonPath = `gallery/public/data/pictures.json`;

        try {
            const imgBase64 = (await toBase64(selectedFile)).split(',')[1];
            
            // 1. ì‚¬ì§„ ì—…ë¡œë“œ
            await fetch(`https://api.github.com/repos/${repo}/contents/${imgPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Add new memory", content: imgBase64 })
            });

            // 2. JSON ë°ì´í„° ì—…ë°ì´íŠ¸
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}?v=${Date.now()}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const fileData = await res.json();
            const currentContent = decodeURIComponent(atob(fileData.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            let currentList = JSON.parse(currentContent);

            currentList.unshift({
                img: `picture/${fileName}`,
                title: document.getElementById('title').value,
                date: new Date().toISOString().split('T')[0],
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
                description: document.getElementById('description').value
            });

            const updatedContent = btoa(encodeURIComponent(JSON.stringify(currentList, null, 2)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));

            await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Update Gallery Data", content: updatedContent, sha: fileData.sha })
            });

            status.innerHTML = "<b>âœ… ë“±ë¡ ì™„ë£Œ. ê³§ ê°¤ëŸ¬ë¦¬ì—ì„œ ë§Œë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</b>";
            setTimeout(() => location.reload(), 2000);
        } catch (err) {
            status.textContent = "ì €ì¥ ì‹¤íŒ¨: GitHub ê¶Œí•œì´ë‚˜ ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.";
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
</script>
</body>
</html>