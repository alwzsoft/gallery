<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moa Admin - AI Smart Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <style>
        :root { --primary: #6b705c; --bg: #f8f9fa; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: var(--primary); margin-bottom: 30px; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9em; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        
        /* AI 섹션 스타일 */
        .ai-box { background: #f1f3f5; border: 1px dashed #ced4da; }
        .btn-ai { background: #6c757d; color: white; margin-top: 5px; }
        .btn-ai:hover { background: #5a6268; }
        
        /* 등록 버튼 스타일 */
        .btn-submit { background: var(--primary); color: white; margin-top: 10px; font-size: 1.1em; }
        
        #preview { width: 100%; border-radius: 8px; margin-top: 10px; display: none; border: 1px solid #eee; }
        .proposal-card { background: white; padding: 12px; margin-top: 10px; border-radius: 6px; cursor: pointer; font-size: 0.85em; border: 1px solid #dee2e6; }
        .proposal-card:hover { border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #status { font-size: 0.85em; text-align: center; margin-top: 15px; color: #666; min-height: 1.2em; }
    </style>
</head>
<body>

<div class="container">
    <h2>Moa Art Registry</h2>

    <div class="section">
        <label>1. 사진 선택</label>
        <input type="file" id="photoInput" accept="image/*">
        <img id="preview">
    </div>

    <div id="aiSection" class="section ai-box" style="display:none;">
        <label>2. AI 문구 제안 (선택 사항)</label>
        <input type="password" id="geminiKey" placeholder="Gemini API Key를 입력하세요">
        <button class="btn-ai" onclick="askGemini()">✨ AI에게 3가지 문구 추천받기</button>
        <div id="proposals"></div>
    </div>

    <div class="section">
        <label>3. 정보 입력 및 등록</label>
        <input type="text" id="title" placeholder="제목">
        <input type="text" id="tags" placeholder="태그 (쉼표로 구분)">
        <textarea id="description" rows="3" placeholder="사진 설명을 입력하세요"></textarea>
        
        <label style="margin-top:10px; color: #888;">GitHub 권한 인증</label>
        <input type="password" id="ghToken" placeholder="GitHub Token (ghp_...)">
        <button class="btn-submit" onclick="handleUpload()">가장 최근 기록으로 등록하기</button>
    </div>

    <div id="status"></div>
</div>

<script>
    window.onload = () => {
        document.getElementById('ghToken').value = localStorage.getItem('moa_gh_token') || '';
        document.getElementById('geminiKey').value = localStorage.getItem('moa_gemini_key') || '';
    };

    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    let selectedFile = null;
    let exifData = {};

    photoInput.onchange = (e) => {
        selectedFile = e.target.files[0];
        if (!selectedFile) return;

        const reader = new FileReader();
        reader.onload = (ex) => {
            preview.src = ex.target.result;
            preview.style.display = 'block';
            document.getElementById('aiSection').style.display = 'block';
            document.getElementById('proposals').innerHTML = '';
        };
        reader.readAsDataURL(selectedFile);

        EXIF.getData(selectedFile, function() {
            const lat = EXIF.getTag(this, "GPSLatitude");
            const lon = EXIF.getTag(this, "GPSLongitude");
            if (lat && lon) {
                exifData.lat = lat[0] + lat[1]/60 + lat[2]/3600;
                exifData.lon = lon[0] + lon[1]/60 + lon[2]/3600;
            }
        });
    };

    async function askGemini() {
        const apiKey = document.getElementById('geminiKey').value.trim();
        if (!apiKey) return alert("AI 제안을 받으려면 Gemini API Key가 필요합니다.");
        localStorage.setItem('moa_gemini_key', apiKey);

        const status = document.getElementById('status');
        status.innerHTML = "<b>AI 분석 중...</b>";

        try {
            const base64Img = await toBase64(selectedFile);
            const prompt = `사진 위치: 위도 ${exifData.lat || '정보없음'}, 경도 ${exifData.lon || '정보없음'}. 
            Moa 갤러리 컨셉(차분함, 기록, 따뜻함)에 맞춰 포스팅 후보 3개를 JSON으로 제안해줘.
            형식: {"proposals": [{"title": "제목", "tags": "태그1, 태그2", "desc": "감성 문구"}]}`;

            // v1 API 경로로 수정하여 404 방지
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: base64Img.split(',')[1] } }
                    ]}]
                })
            });

            const resData = await response.json();
            if (resData.error) throw new Error(resData.error.message);

            const textResponse = resData.candidates[0].content.parts[0].text;
            const cleanJson = JSON.parse(textResponse.replace(/```json|```/g, ''));
            
            displayProposals(cleanJson.proposals);
            status.textContent = "원하는 문구를 클릭하면 입력창에 자동 반영됩니다.";
        } catch (err) {
            console.error(err);
            status.textContent = "AI 호출 에러: " + err.message;
        }
    }

    function displayProposals(proposals) {
        const container = document.getElementById('proposals');
        container.innerHTML = '';
        proposals.slice(0, 3).forEach(p => {
            const div = document.createElement('div');
            div.className = 'proposal-card';
            div.innerHTML = `<strong>${p.title}</strong><br><span style='color:#666;'>${p.desc}</span>`;
            div.onclick = () => {
                document.getElementById('title').value = p.title;
                document.getElementById('tags').value = p.tags;
                document.getElementById('description').value = p.desc;
            };
            container.appendChild(div);
        });
    }

    async function handleUpload() {
        const token = document.getElementById('ghToken').value.trim();
        if (!token || !selectedFile) return alert("GitHub 토큰과 사진 선택은 필수입니다.");
        localStorage.setItem('moa_gh_token', token);

        const status = document.getElementById('status');
        status.textContent = "저장소에 업로드 중입니다...";

        const repo = "alwzsoft/source_only";
        const fileName = Date.now() + ".jpg";
        const imgPath = `gallery/public/picture/${fileName}`;
        const jsonPath = `gallery/public/data/pictures.json`;

        try {
            const imgBase64 = (await toBase64(selectedFile)).split(',')[1];
            
            // 1. 이미지 업로드
            await fetch(`https://api.github.com/repos/${repo}/contents/${imgPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Upload photo", content: imgBase64 })
            });

            // 2. JSON 데이터 업데이트
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}?v=${Date.now()}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            const fileData = await res.json();
            const currentContent = decodeURIComponent(atob(fileData.content).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            let currentList = JSON.parse(currentContent);

            currentList.unshift({
                img: `picture/${fileName}`,
                title: document.getElementById('title').value,
                date: new Date().toISOString().split('T')[0],
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()),
                description: document.getElementById('description').value
            });

            const updatedContent = btoa(encodeURIComponent(JSON.stringify(currentList, null, 2)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1)));

            await fetch(`https://api.github.com/repos/${repo}/contents/${jsonPath}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: "Update pictures.json", content: updatedContent, sha: fileData.sha })
            });

            status.textContent = "✅ 등록 성공! 갤러리가 곧 업데이트됩니다.";
            setTimeout(() => location.reload(), 2000);
        } catch (err) {
            status.textContent = "업로드 오류가 발생했습니다.";
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
</script>
</body>
</html>